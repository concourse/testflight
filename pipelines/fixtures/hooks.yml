---
resources:
  - name: some-git-resource
    type: git
    source:
      uri: {{origin-git-server}}
      branch: master

  - name: some-git-resource-success
    type: git
    source:
      uri: {{success-git-server}}
      branch: success

  - name: some-git-resource-failure
    type: git
    source:
      uri: {{failure-git-server}}
      branch: failure

  - name: some-git-resource-no-update
    type: git
    source:
      uri: {{no-update-git-server}}
      branch: no-update

  - name: some-git-resource-ensure-success
    type: git
    source:
      uri: {{ensure-success-git-server}}
      branch: ensure-success

  - name: some-git-resource-ensure-failure
    type: git
    source:
      uri: {{ensure-failure-git-server}}
      branch: ensure-failure
  
  - name: some-git-resource-ensure-abort
    type: git
    source:
        uri: {{ensure-abort-git-server}}
        branch: ensure-abort

jobs:
  - name: some-passing-job
    plan:
      - get: some-git-resource
        trigger: true
      - task: curl-server
        config:
          platform: linux
          image_resource:
            type: docker-image
            source: {repository: concourse/bosh-deployment-resource}
          inputs:
            - name: some-git-resource
          params:
            CURL_COMMAND: {{guid-server-curl-command}}
          run:
            path: sh
            args: ["-c", "tail -1 some-git-resource/guids | $CURL_COMMAND && cp -r some-git-resource/. curl-server-output"]
          outputs:
          - name: curl-server-output
        ensure:
          put: some-git-resource-ensure-success
          params:
            repository: curl-server-output
        on_success:
          put: some-git-resource-success
          params:
            repository: curl-server-output
        on_failure:
          put: some-git-resource-no-update
          params:
            repository: curl-server-output

  - name: some-failing-job
    plan:
      - get: some-git-resource
        trigger: true
      - task: fail
        config:
          platform: linux
          inputs:
            - name: some-git-resource
          run:
            path: sh
            args: ["-c", "cp -r some-git-resource/. fail-output && exit 1"]
          outputs:
            - name: fail-output
        ensure:
          put: some-git-resource-ensure-failure
          params:
            repository: fail-output
        on_success:
          put: some-git-resource-no-update
          params:
            repository: fail-output
        on_failure:
          put: some-git-resource-failure
          params:
            repository: fail-output

  - name: some-aborted-job
    plan:
      - get: some-git-resource
        trigger: true
      - task: ensure
        config:
          platform: linux
          inputs:
            - name: some-git-resource
          run:
            path: sh
            args: ["-c", "cp -r some-git-resource/. ensure-output && sleep 5"]
          outputs:
            - name: ensure-output
        ensure:
          put: some-git-resource-ensure-abort
          params:
            repository: ensure-output
